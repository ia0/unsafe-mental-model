<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>What is unsafe? - Mental model for unsafe in Rust</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Mental model for unsafe in Rust</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ia0/unsafe-mental-model" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ia0/unsafe-mental-model/edit/main/src/what-is-unsafe.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="what-is-unsafe"><a class="header" href="#what-is-unsafe">What is unsafe?</a></h1>
<p>This chapter provides the mental model of unsafe, relying on the concepts of the previous chapters.</p>
<h2 id="anonymous-types"><a class="header" href="#anonymous-types">Anonymous types</a></h2>
<p>Unsafe is a way to locally introduce an <em>anonymous type</em> given its interpretation. In practice, this
is done by reusing the interpretation of an existing type and documenting how that interpretation is
modified. For example, an occurrence of <code>*const i32</code> in the program could be documented as being
restricted to values that are valid for read, aligned, and pointing to an initialized <code>i32</code>. That
particular occurrence of <code>*const i32</code> would actually be an anonymous type created for the occasion
with the documented interpretation, essentially updating the contract at that location.</p>
<h2 id="proofs"><a class="header" href="#proofs">Proofs</a></h2>
<p>Recall how using an expression of type <code>A</code> where a value of type <code>B</code> is expected requires to show
that <code>A</code> is a subtype of <code>B</code>. When using unsafe, it may happen that this is not the case. This
usually happens when <code>B</code> is an anonymous type over <code>A</code>, like the <code>*const i32</code> example above. In
those cases, one has to manually prove that the possible values of the expression are actually in
<code>B</code>. This proof cannot rely on types and must rely on the correctness of the program.</p>
<h2 id="validity"><a class="header" href="#validity">Validity</a></h2>
<p>Rust has an unusual concept compared to other type systems. It has an additional notion of type
interpretation. Besides the usual interpretation of types which defines the set of <em>safe values</em> (as
defined by the <a href="https://www.ralfj.de/blog/2018/08/22/two-kinds-of-invariants.html">safety invariant</a> of the type), there is an interpretation of types
which defines the set of <em>valid values</em> (as defined by the <a href="https://www.ralfj.de/blog/2018/08/22/two-kinds-of-invariants.html">validity invariant</a> of
the type). The compiler doesn't know that only safe values are possible, it believes that <em>unsafe
values</em> (values that are valid but not safe) are also possible, and will not optimize if an unsafe
value would invalidate the optimization.</p>
<p>This notion is actually necessary due to type composition: an anonymous type in a contra-variant
position would actually increase the set of possible values. The validity invariant must at least
contain the interpretation of the type where all types in contra-variant positions have been
replaced by the <em>bottom type</em> (the type with an empty interpretation).</p>
<h2 id="properties"><a class="header" href="#properties">Properties</a></h2>
<p>Unsafe may only update interpretations within the bounds of the validity invariant. In particular,
it may add unsafe values and it may remove safe values, but it may not do anything else. An <em>unsafe
type</em> contains at least one unsafe value and a <em>robust type</em> is missing at least one safe value. By
those definitions, a <em>safe type</em> is neither unsafe nor robust, its interpretation is exactly the
safe values. Only anonymous types may be unsafe and/or robust. In particular, an anonymous type may
be both unsafe and robust.</p>
<p>An unsafe type is a type that has <em>restrictions to use</em>, because one needs to take care of those
additional values. A robust type on the contrary is a type that provides <em>permissions to use</em>,
because some safe but otherwise problematic values are now absent.</p>
<p>Let's illustrate this with the function type <code>fn(P) -&gt; R</code>. By contra-variance, it is unsafe if <code>P</code>
is robust. This is the most common case, because <code>P</code> has permissions to use that its safe version
would otherwise not have. And by co-variance, it is unsafe if <code>R</code> is unsafe. This is less common,
but happens when <code>R</code> has restrictions to use, like <code>Pin::get_unchecked_mut() -&gt; &amp;mut T</code>.</p>
<p>Similarly for the mutable reference type <code>&amp;mut [T .. S]</code>. By contra-variance, it is unsafe if <code>S</code> is
robust. This is the case with the result type of <code>String::as_mut_vec() -&gt; &amp;mut Vec&lt;u8&gt;</code> that
requires permissions to use <code>S</code> as UTF-8 (removing the safe values of <code>Vec&lt;u8&gt;</code> that are not UTF-8).
By co-variance, it is unsafe if <code>T</code> is unsafe. This is the case with the result type of
<code>Pin::get_unchecked_mut() -&gt; &amp;mut T</code> that enforces restrictions to use <code>T</code> as possibly pinned
(adding the unsafe values that are safe when under <code>Pin</code>). Note that <code>S</code> also has restrictions to
use (the same ones as <code>T</code>), thus by contra-variance making the result type and thus the type of
<code>Pin::get_unchecked_mut()</code> robust (remember that types may be both unsafe and robust).</p>
<h2 id="custom-types"><a class="header" href="#custom-types">Custom types</a></h2>
<p>It is interesting to observe that for builtin types, the origin of unsafe seems to always be a
robust type in contra-variant position. We could thus think that it would be enough to only update
types down from the safety invariant instead of the validity invariant. But keeping the option to
add unsafe values to a type is necessary for custom types and reverting the effect of an anonymous
type.</p>
<p>A custom type gives a name to a type expression, its definition. When the custom type is used
instead of its definition, anonymous types can only be introduced directly on the custom type
because the definition is hidden. If one wanted to make the type unsafe by making a contra-variant
type robust within the definition, now one needs to make the custom type unsafe by adding unsafe
values.</p>
<p>Let's use the function type <code>fn(*const i32)</code> as initial illustration. If we define a custom type
<code>Foo</code> with that function type as definition and we want a specific usage of <code>Foo</code> to actually
contain unsafe functions, we can't introduce an anonymous type on <code>*const i32</code> because it's hidden
behind the definition of <code>Foo</code>. We have to introduce the anonymous type on <code>Foo</code>, which is the only
thing visible, and add those unsafe values.</p>
<p>It is also possible for a custom type definition to have an anonymous type. This is for example the
case of <code>Vec&lt;i32&gt;</code>. Its simplified definition is an anonymous type on <code>{ ptr: *mut i32, len: usize, cap: usize }</code> removing some safe values. We'll focus on the safe values where not all of the first
<code>len</code> elements pointed by <code>ptr</code> are initialized. The safety invariant of <code>Vec&lt;i32&gt;</code> thus doesn't
contain those (otherwise safe) values, making a pointer to uninitialized data with non-zero length
an unsafe value for that type. One may want to add those unsafe values for some specific occurrences
of <code>Vec&lt;i32&gt;</code>, requiring again an anonymous type. This time it's not only because the definition is
hidden, but also because we want to revert the effect of an anonymous type adding back values that
were removed.</p>
<p>Note that, while anonymous types in custom types define a new safety invariant, it is also possible
to define custom types with a different validity invariant using rustc annotations. For example,
<code>NonZeroI32</code> has the value zero removed from both the safety invariant and the validity invariant.
This type doesn't have any unsafe value. It is thus not possible to create an unsafe version of that
type. If you would remove the rustc annotations and keep the anonymous type, then zero would not be
safe but still be valid, and thus it would be an unsafe value that can be added to create an unsafe
version of that type.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="mutable-references.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="making-it-explicit.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="mutable-references.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="making-it-explicit.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
